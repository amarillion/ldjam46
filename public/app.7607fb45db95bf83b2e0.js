!function(t){function e(e){for(var i,a,r=e[0],h=e[1],c=e[2],l=0,p=[];l<r.length;l++)a=r[l],Object.prototype.hasOwnProperty.call(o,a)&&o[a]&&p.push(o[a][0]),o[a]=0;for(i in h)Object.prototype.hasOwnProperty.call(h,i)&&(t[i]=h[i]);for(d&&d(e);p.length;)p.shift()();return n.push.apply(n,c||[]),s()}function s(){for(var t,e=0;e<n.length;e++){for(var s=n[e],i=!0,r=1;r<s.length;r++){var h=s[r];0!==o[h]&&(i=!1)}i&&(n.splice(e--,1),t=a(a.s=s[0]))}return t}var i={},o={0:0},n=[];function a(e){if(i[e])return i[e].exports;var s=i[e]={i:e,l:!1,exports:{}};return t[e].call(s.exports,s,s.exports,a),s.l=!0,s.exports}a.m=t,a.c=i,a.d=function(t,e,s){a.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:s})},a.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},a.t=function(t,e){if(1&e&&(t=a(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var s=Object.create(null);if(a.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)a.d(s,i,function(e){return t[e]}.bind(null,i));return s},a.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return a.d(e,"a",e),e},a.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},a.p="";var r=window.webpackJsonp=window.webpackJsonp||[],h=r.push.bind(r);r.push=e,r=r.slice();for(var c=0;c<r.length;c++)e(r[c]);var d=h;n.push([1471,1]),s()}({1468:function(t,e){class s extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"}),this.shadowRoot.innerHTML="\n\t<style>\n\t\t.main {\n\t\t\tposition: relative;\n\t\t\theight: 100%;\n\t\t\tdisplay: grid;\n\t\t\tgrid-template: auto 1fr auto / 1fr;\n\t\t}\n\t\t\n\t\t.buttonBar div {\n\t\t\tborder: 1px solid white;\n\t\t\twidth: 64px;\n\t\t\tbackground: #777700;\n\t\t\tborder-radius: 5px;\n\t\t\tdisplay: inline-block;\n\t\t\tmargin: 8px;\n\t\t}\n\t\timg {\n\t\t\talign: center;\n\t\t}\n\t\t\n\t\t.text {\n\t\t\tbackground: white;\n\t\t\tmargin: 10px;\n\t\t}\n\n\t\t#speciesButton {\n\t\t\twidth: 200px;\n\t\t\tmargin: 8px;\n\t\t}\n\t</style>\n\n\t<div class=\"main\">\n\t\t<div class=\"buttonBar\">\n\t\t\t<div role='button' id='species0'><img src='./assets/images/species/fungi0.png'></div>\n\t\t\t<div role='button' id='species1'><img src='./assets/images/species/herbivore0.png'></div>\n\t\t\t<div role='button' id='species2'><img src='./assets/images/species/plant0.png'></div>\n\t\t\t<div role='button' id='species3'><img src='./assets/images/species/plant1.png'></div>\n\t\t</div>\n\t\t<div class=\"text\">\n\t\t\tLorem ipsum...\n\t\t</div>\n\t\t<button id=\"speciesButton\">Introduce species</button>\n\t</div>\n"}connectedCallback(){console.log("connected callback"),this.shadowRoot.querySelector("#species0").addEventListener("click",t=>{console.log("Selected species 0")}),this.shadowRoot.querySelector("#speciesButton").addEventListener("click",t=>{console.log("Introduce species")})}}customElements.define("exo-species-window",s)},1469:function(t,e){class s extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"})}set text(t){this.shadowRoot.innerHTML=`\n\t<style>\n\t\tpre {\n\t\t\toverflow: hidden;\n\t\t}\n\t</style>\n\n\t<pre>${t}</pre>\n`}}customElements.define("exo-planet-window",s)},1470:function(t,e){class s extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"})}set text(t){this.shadowRoot.innerHTML=`\n\t<style>\n\t\tpre {\n\t\t\toverflow: hidden;\n\t\t}\n\t</style>\n\n\t<pre>${t}</pre>\n`}}customElements.define("exo-detail-window",s)},1471:function(t,e,s){"use strict";s.r(e);var i=s(14),o=s.n(i),n=s(550),a=s.n(n),r=class extends o.a.Scene{constructor(){super({key:"BootScene"})}preload(){this.fontsReady=!1,this.fontsLoaded=this.fontsLoaded.bind(this),this.add.text(100,100,"loading fonts..."),this.load.image("loaderBg","./assets/images/loader-bg.png"),this.load.image("loaderBar","./assets/images/loader-bar.png"),this.load.image("biotopeTiles","./assets/images/biotope.png"),this.load.tilemapTiledJSON("planetScape","./assets/planetscape.json"),this.load.image("speciesTiles","./assets/images/species.png"),this.load.tilemapTiledJSON("speciesMap","./assets/speciesmap.json"),a.a.load({google:{families:["Bangers"]},active:this.fontsLoaded})}update(){this.fontsReady&&this.scene.start("SplashScene")}fontsLoaded(){this.fontsReady=!0}},h=class extends o.a.Scene{constructor(){super({key:"SplashScene"})}preload(){this.load.image("mushroom","assets/images/mushroom2.png")}create(){this.scene.start("GameScene")}update(){}};function c(t){return Math.floor(Math.random()*Math.floor(t))}const d=0,l=1,p=2,u=0,m=2,g=3,f=[{name:"unnamed_algae_0",role:l,tileIdx:0,interactionMap:{5:m,6:g},biotopeTolerances:{0:1,1:.5,2:.5,3:.5,4:.5,5:.5,6:.1,7:.5},optimalTemperature:200,backstory:null,profilePictureKey:null,tileIndex:null,color:16776960},{name:"unnamed_herbivore_1",role:p,tileIdx:4,interactionMap:{0:u,3:u},biotopeTolerances:{0:1,1:1,2:.5,3:.5,4:.1,5:.5,6:.5,7:.5},optimalTemperature:200,backstory:null,profilePictureKey:null,tileIndex:null,color:16711935},{name:"unnamed_fungus_2",role:d,tileIdx:1,interactionMap:{3:g},biotopeTolerances:{0:.5,1:1,2:.5,3:.1,4:.5,5:.5,6:.5,7:.5},optimalTemperature:200,backstory:null,profilePictureKey:null,tileIndex:null,color:65535},{name:"unnamed_algae_3",role:l,tileIdx:2,interactionMap:{5:m,6:g},biotopeTolerances:{0:1,1:.5,2:.5,3:.5,4:.5,5:.5,6:.1,7:.5},optimalTemperature:200,backstory:null,profilePictureKey:null,tileIndex:null,color:16711680}];class b extends Error{constructor(t){super(t)}}function y(t,e){if(!t)throw console.error(e),new b(e)}class x{constructor(t,e,s){this.x=t,this.y=e,this.deadBiomass=10,this.co2=1e3,this.o2=10,this.h2o=1e3,this.latitude=s,this.heat=220,this.stellarEnergy=3.5*Math.cos(this.latitude/180*3.141),y(this.stellarEnergy>=0),this._species=[]}sumLivingBiomass(){return this._species.reduce((t,e)=>t+e.biomass,0)}get species(){return this._species}addSpecies(t,e){const s=this._species.find(e=>e.speciesId===t);s?(s.biomass+=e,this.sortSpecies()):(this._species.push({speciesId:t,biomass:e}),this.maxSpeciesCheck())}maxSpeciesCheck(){if(this.sortSpecies(),this._species.length>8){const t=this._species.pop();this.deadBiomass+=t.biomass}}sortSpecies(){this._species.sort((t,e)=>e.biomass-t.biomass)}speciesToString(){return this._species.map(t=>`${t.speciesId}: ${t.biomass.toFixed(1)}`).join("\n  ")}toString(){return`[${this.x}, ${this.y}] Biotope: ${this.biotope}\nHeat: ${this.heat.toExponential(2)} GJ/km^2\nTemperature: ${this.temperature.toFixed(0)} K\nHeat gain from sun: ${this.stellarEnergy.toExponential(2)} GJ/km^2/tick\nHeat loss to space: ${this.heatLoss.toExponential(2)} GJ/km^2/tick\nLatitude: ${this.latitude.toFixed(0)} deg\n\nCO2: ${this.co2.toFixed(1)}\nH2O: ${this.h2o.toFixed(1)}\nO2: ${this.o2.toFixed(1)}\nOrganic: ${this.deadBiomass.toFixed(1)}\n\nSpecies: ${this.speciesToString()}`}growAndDie(){for(const t of this._species){const e=f[t.speciesId];let s=1;if(y(this.biotope in e.biotopeTolerances),s*=e.biotopeTolerances[this.biotope],y(s>=0&&s<=1),e.role===l){const e=Math.min(this.co2,this.h2o),i=s*this.stellarEnergy*3e-5*e,o=Math.min(t.biomass*i,this.co2,this.o2);y(o>=0),this.co2-=o,this.h2o-=o,this.o2+=o,t.biomass+=o,y(t.biomass>=0)}else if(e.role===p)for(const i of this._species){if(i.speciesId===t.speciesId)continue;if(e.interactionMap[i.speciesId]===u){const e=.001*s*i.biomass,o=Math.min(t.biomass*e,i.biomass);y(o>=0),i.biomass-=o,t.biomass+=o,y(t.biomass>=0),y(i.biomass>=0)}}else if(e.role===d){const e=.001*s*this.deadBiomass,i=Math.min(t.biomass*e,this.deadBiomass);y(i>=0),this.deadBiomass-=i,t.biomass+=i,y(this.deadBiomass>=0),y(t.biomass>=0)}if(e.role!==l){const e=.001*Math.min(t.biomass,this.o2),s=Math.min(t.biomass,t.biomass*e,this.o2);y(s>=0),this.o2-=s,t.biomass-=s,this.h2o+=s,this.co2+=s,y(this.deadBiomass>=0),y(t.biomass>=0)}{y(t.biomass>=0,`Wrong value ${t.biomass} ${t.speciesId}`);const e=Math.min(1,.01/Math.max(s,1e-4)),i=Math.min(t.biomass*e,t.biomass);y(i>=0),this.deadBiomass+=i,t.biomass-=i,y(t.biomass>=0)}y(t.biomass>=0)}y(this.o2>=0),y(this.co2>=0),y(this.h2o>=0),y(this.deadBiomass>=0),this.sortSpecies()}migrateTo(t){if(0!==this._species.length)for(const e of this._species){const s=.01*e.biomass;t.addSpecies(e.speciesId,s),e.biomass-=s}}diffuseProperty(t,e,s){const i=this[e]*s-t[e]*s;this[e]-=i,t[e]+=i,y(this[e]>=0),y(t[e]>=0)}diffusionTo(t){{const e=this.temperature<216?.001:.1;this.diffuseProperty(t,"co2",e)}{const e=this.temperature<273?.001:.1;this.diffuseProperty(t,"h2o",e)}{const e=.1;this.diffuseProperty(t,"o2",e)}{const e=.1;this.diffuseProperty(t,"heat",e)}}updatePhysicalProperties(){this.temperature=this.heat/1,this.heat+=this.stellarEnergy;this.heatLoss=.01*this.heat,this.heat-=this.heatLoss}updateStats(t){t.co2+=this.co2,t.o2+=this.o2,t.h2o+=this.h2o,t.deadBiomass+=this.deadBiomass;for(const{speciesId:e,biomass:s}of this._species)e in t.species||(t.species[e]=0),t.species[e]+=s}}class w{constructor(t,e,s=(t=>(e,s)=>new x(e,s,160*s/(t-1)-80))(e)){this.cellFactory=s,this.width=t,this.height=e,this._prepareGrid()}_prepareGrid(){this._data=new Array(this.width*this.height);for(let t=0;t<this.width;++t)for(let e=0;e<this.height;++e)this._data[this._index(t,e)]=this.cellFactory(t,e)}randomCell(){let t=c(this._data.length);return this._data[t]}_index(t,e){return t+e*this.width}get(t,e){return this.inRange(t,e)?this._data[this._index(t,e)]:null}inRange(t,e){return t>=0&&e>=0&&t<this.width&&e<this.height}*eachNode(){for(const t of this._data)t&&(yield t)}*eachNodeCheckered(){y(this._data.length%523!=0);let t=0;for(let e=0;e<this._data.length;++e){t=(t+523)%this._data.length;const e=this._data[t];yield e}}*getAdjacent(t){let e=0,s=-1;const i=t.x,o=t.y;for(const t of[1,2,4,8]){const n=(i+e+this.width)%this.width,a=o+s;if(a>=0&&a<this.height){const e=this._data[this._index(n,a)];yield[t,e]}[e,s]=[-s,e]}}}class S{constructor(){this.reset()}reset(){this.temperature=0,this.co2=0,this.o2=0,this.h2o=0,this.deadBiomass=0,this.species={}}speciesToString(){return Object.entries(this.species).map(([t,e])=>`${t}: ${e.toFixed(0)}`).join("\n  ")}toString(){return`Average Temperature: ${this.temperature.toFixed(0)} K\n\nCO2: ${this.co2.toFixed(1)}\nH2O: ${this.h2o.toFixed(1)}\nO2: ${this.o2.toFixed(1)}\nOrganic: ${this.deadBiomass.toFixed(1)}\n\nSpecies: ${this.speciesToString()}`}}let k=0;class v{constructor(){this.id=k++,this.dna="",this.calculateProperties()}calculateProperties(){}}class M{constructor(t,e){this.grid=new w(t,e),this.species={},this.planet=new S,this.init(),this.tickCounter=0}init(){for(let t=0;t<4;++t){const t=this.createSpecies();for(let e=0;e<5;++e){this.grid.randomCell().addSpecies(t.id,100)}}}createSpecies(){const t=new v;return this.species[t.id]=t,t}tick(){this.updatePhysicalProperties(),this.growAndDie(),this.interact(),this.evolve(),this.migrate(),this.updatePlanet(),this.tickCounter+=1}updatePhysicalProperties(){for(const t of this.grid.eachNode())t.updatePhysicalProperties();for(const t of this.grid.eachNodeCheckered())for(const[,e]of this.grid.getAdjacent(t))t.diffusionTo(e)}growAndDie(){for(const t of this.grid.eachNode())t.growAndDie()}interact(){}evolve(){}migrate(){for(const t of this.grid.eachNodeCheckered())for(const[,e]of this.grid.getAdjacent(t))t.migrateTo(e)}updatePlanet(){this.planet.reset();let t=0,e=0;for(const s of this.grid.eachNode())e+=s.temperature,t++,s.updateStats(this.planet);this.planet.temperature=e/t}}class T extends o.a.GameObjects.Graphics{constructor(t,e,s){super(t,s),this.grid=e,this.prop=()=>1,this.autoMin=!1,this.fixedMin=0,this.color=16711680,this.update()}setProp(t,e=!1){this.prop=t,this.autoMin=e}minMax(t){let e=1/0,s=-1/0;for(const i of this.grid.eachNode()){const o=t(i);o<e&&(e=o),o>s&&(s=o)}return{min:e,max:s}}update(){function t(t,e,s){const i=s-e;return i?(t-e)/i:0}this.clear();const e=this.prop;let{min:s,max:i}=this.minMax(e);this.autoMin||(s=this.fixedMin);for(const o of this.grid.eachNode()){const n=64*o.x,a=64*o.y,r=t(e(o),s,i);this.fillStyle(this.color,r),this.fillRect(n,a,63,63)}}}class _ extends o.a.GameObjects.Graphics{constructor(t,e){super(t,e),this.mx=0,this.my=0,this.visible=!1,this.update()}setCoord(t,e){this.mx=t,this.my=e,this.visible=!0,this.update()}update(){this.clear();const t=64*this.mx,e=64*this.my;this.lineStyle(1,16777215,1),this.strokeRect(t-1,e-1,66,66)}}var P=class extends o.a.Scene{constructor(){super({key:"GameScene"})}init(){this.time.addEvent({delay:500,callback:()=>this.tickAndLog(),loop:!0})}preload(){}create(){console.log("Game.create called"),this.planetMap=this.add.tilemap("planetScape"),this.initSim(this.planetMap),this.logElement=document.getElementsByTagName("exo-detail-window")[0],this.planetElement=document.getElementsByTagName("exo-planet-window")[0],this.gridView=new T(this,this.sim.grid),this.cursor=new _(this);const t=this.planetMap.addTilesetImage("biotope","biotopeTiles");this.backgroundLayer=this.planetMap.createStaticLayer("Tile Layer 1",t),this.add.existing(this.gridView),this.speciesMap=this.add.tilemap("speciesMap");const e=this.speciesMap.addTilesetImage("species","speciesTiles");this.backgroundLayer=this.speciesMap.createDynamicLayer("Tile Layer 1",e),this.add.existing(this.cursor),this.input.on("pointermove",this.onMouseMove,this),this.input.on("pointerup",this.onMouseClick,this),this.input.keyboard.on("keydown",this.onKeyDown,this),this.setFilter(1);var s=this.input.keyboard.createCursorKeys(),i={camera:this.cameras.main,left:s.left,right:s.right,up:s.up,down:s.down,zoomIn:this.input.keyboard.addKey(o.a.Input.Keyboard.KeyCodes.Q),zoomOut:this.input.keyboard.addKey(o.a.Input.Keyboard.KeyCodes.E),acceleration:.06,drag:5e-4,maxSpeed:1};this.controls=new o.a.Cameras.Controls.SmoothedKeyControl(i),this.add.text(0,0,"Exo Keeper",{font:"32px Bangers",fill:"#7744ff"}),this.scale.on("resize",(function(t){var e=t.width,s=t.height;this.cameras.resize(e,s)}),this)}initSim(t){this.sim=new M(t.width,t.height),this.currentCell=this.sim.grid.get(0,0),this.initBiotopes(t)}initBiotopes(t){for(let e=0;e<t.width;++e)for(let s=0;s<t.height;++s){const i=t.getTileAt(e,s).index-1;this.sim.grid.get(e,s).biotope=i}}tickAndLog(){this.sim.tick(),this.gridView.update(),this.logElement.text=this.currentCell.toString(),this.planetElement.text=`Tick: ${this.sim.tickCounter}\n${this.sim.planet}`,this.updateSpeciesMap()}updateSpeciesMap(){for(const t of this.sim.grid.eachNode()){const e=2*t.x+.5,s=2*t.y+.5;let i=.5,o=.5;for(const{speciesId:n,biomass:a}of t.species.slice(0,4)){if(a<50)continue;const t=f[n].tileIdx;this.speciesMap.putTileAt(t+1,e+i,s+o),[i,o]=[-o,i]}}}update(t,e){this.controls.update(e)}toGridCoords({x:t,y:e}){let s=this.cameras.main.getWorldPoint(t,e);return{mx:Math.floor(s.x/64),my:Math.floor(s.y/64)}}onMouseClick(t){const{mx:e,my:s}=this.toGridCoords(t),i=this.sim.grid.get(e,s);i&&(this.currentCell=i)}onMouseMove(t){const{mx:e,my:s}=this.toGridCoords(t);this.sim.grid.inRange(e,s)&&this.cursor.setCoord(e,s)}onKeyDown(t){switch(t.keyCode){case o.a.Input.Keyboard.KeyCodes.ONE:this.setFilter(1),t.stopPropagation();break;case o.a.Input.Keyboard.KeyCodes.TWO:this.setFilter(2),t.stopPropagation();break;case o.a.Input.Keyboard.KeyCodes.THREE:this.setFilter(3),t.stopPropagation();break;case o.a.Input.Keyboard.KeyCodes.FOUR:this.setFilter(4),t.stopPropagation();break;case o.a.Input.Keyboard.KeyCodes.FIVE:this.setFilter(5),t.stopPropagation();break;case o.a.Input.Keyboard.KeyCodes.SIX:this.setFilter(6),t.stopPropagation()}}setFilter(t){switch(t){case 1:this.gridView.setProp(t=>t.sumLivingBiomass()),this.gridView.color=8978312;break;case 2:this.gridView.color=65280,this.gridView.setProp(t=>t.co2);break;case 3:this.gridView.color=16746632,this.gridView.setProp(t=>t.o2);break;case 4:this.gridView.color=255,this.gridView.setProp(t=>t.h2o);break;case 5:this.gridView.color=16776960,this.gridView.setProp(t=>t.heat,!0);break;case 6:this.gridView.color=16746496,this.gridView.setProp(t=>t.stellarEnergy)}}};s(1468),s(1469),s(1470);const C=()=>.67*window.innerWidth,I=()=>.67*window.innerHeight,E={type:o.a.AUTO,localStorageName:"exokeeper",disableContextMenu:!0,backgroundColor:"#041849",fps:{target:20},scale:{mode:o.a.Scale.NONE,width:C(),height:I(),parent:"content"}},B=Object.assign(E,{scene:[r,h,P]});class O extends o.a.Game{constructor(){super(B)}}window.game=new O,window.addEventListener("resize",(function(){window.game.scale.resize(C(),I())}),!1)}});